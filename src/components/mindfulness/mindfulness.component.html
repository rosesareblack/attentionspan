<div class="h-full w-full flex flex-col items-center justify-center p-4 sm:p-6 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-colors duration-500 relative overflow-hidden">
  
  <!-- Calming Animated Background -->
  <div class="absolute inset-0 z-0 bg-gradient-to-br from-blue-100 via-indigo-100 to-purple-100 dark:from-blue-900/30 dark:via-indigo-900/30 dark:to-purple-900/30 animate-gradient-xy"></div>
  
  <div class="relative z-10 flex flex-col items-center">
    <div class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">Mindfulness Practice</h1>
      <p class="text-slate-600 dark:text-slate-400">Box Breathing Exercise</p>
    </div>

    <div class="relative w-64 h-64 sm:w-80 sm:h-80 flex items-center justify-center mb-8">
      <!-- Outer pulsating ring for ambience -->
      <div class="absolute inset-0 bg-blue-500/10 dark:bg-blue-400/10 rounded-full"
          [class.animate-pulse]="sessionActive()">
      </div>
      
      <!-- Main visualizer circle -->
      <div class="relative w-48 h-48 sm:w-56 sm:h-56 bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg rounded-full shadow-lg transition-transform duration-[4000ms] ease-in-out flex items-center justify-center"
          [class.scale-125]="animationState() === 'inhale'"
          [class.scale-100]="animationState() === 'exhale' || animationState() === 'idle'"
          [class.scale-125]="animationState() === 'hold'">
        
        <!-- Inner text -->
        <div class="text-center">
          @if (sessionActive()) {
            <p class="text-5xl font-bold tabular-nums text-slate-700 dark:text-slate-200">{{ formatTime(timeRemaining()) }}</p>
          } @else if (sessionCompleted()) {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-16 h-16 text-green-500 dark:text-green-400">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
          } @else {
            <p class="text-2xl font-semibold text-slate-500">Ready?</p>
          }
        </div>
      </div>
    </div>

    <p class="text-2xl font-semibold h-8 mb-8 text-center text-slate-700 dark:text-slate-300 transition-opacity duration-300">{{ instruction() }}</p>

    <!-- Controls -->
    <div class="flex flex-col items-center gap-4 w-full max-w-sm">
      @if (!sessionActive()) {
        <div class="w-full animate-fade-in-controls text-center relative">
          <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Session Duration</label>
          <button popovertarget="durationPopover"
                  [disabled]="sessionActive()"
                  class="w-40 px-4 py-2 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <span>{{ selectedDuration() }} min</span>
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-slate-500 transition-transform" [class.rotate-180]="durationPopoverOpen()">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          
          <div popover id="durationPopover" (toggle)="onPopoverToggle($event)" class="w-40 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md shadow-lg overflow-hidden">
              @for (duration of [1, 3, 5]; track duration) {
                  <button (click)="setDuration(duration)"
                          class="w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-blue-500/10 transition-colors"
                          [class.text-blue-600]="selectedDuration() === duration"
                          [class.dark:text-blue-400]="selectedDuration() === duration"
                          [class.font-semibold]="selectedDuration() === duration">
                      {{ duration }} min
                  </button>
              }
          </div>
        </div>
      }

      <button (click)="toggleSession()" class="w-full max-w-xs px-6 py-4 rounded-full text-white font-bold text-lg transition-all duration-300 shadow-lg transform active:scale-95"
              [class.bg-blue-600]="!sessionActive()"
              [class.hover:bg-blue-700]="!sessionActive()"
              [class.bg-red-600]="sessionActive()"
              [class.hover:bg-red-700]="sessionActive()">
        @if (sessionActive()) {
          <span>Stop Session</span>
        } @else {
          <span>Start Session</span>
        }
      </button>
    </div>
  </div>
</div>
<style>
  @keyframes gradient-xy {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
  }
  .animate-gradient-xy {
      background-size: 200% 200%;
      animation: gradient-xy 15s ease infinite;
  }
   @keyframes fade-in-controls {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in-controls {
    animation: fade-in-controls 0.5s ease-out forwards;
  }

  @keyframes popover {
    from { opacity: 0; transform: translateY(5px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  [popover] {
    animation: popover 0.15s ease-out forwards;
    inset: auto; /* Reset browser default positioning */
    margin: 0;
  }

  /* Position popover above the button */
  #durationPopover {
    bottom: 100%;
    margin-bottom: 0.5rem;
    left: 50%;
    transform: translateX(-50%);
  }
</style>